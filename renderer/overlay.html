<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        /* Reset & Base */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        }

        /* Glow animation */
        @keyframes borderGlow {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(139, 92, 246, 0.3), 0 0 30px rgba(139, 92, 246, 0.1);
            }

            50% {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
            }
        }

        @keyframes subtlePulse {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100px;
            /* Glass Effect */
            background: rgba(12, 12, 20, 0.35);
            color: #e0e0e0;
            border-radius: 16px;
            /* Purple neon glow border */
            border: 1px solid rgba(139, 92, 246, 0.4);
            box-shadow:
                0 0 15px rgba(139, 92, 246, 0.15),
                0 0 30px rgba(139, 92, 246, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden;
            position: relative;
            pointer-events: none;
            user-select: none;
        }

        /* Strip Mode (Top Bar) */
        .strip-header {
            display: flex;
            align-items: center;
            padding: 0 16px;
            height: 100px;
            gap: 14px;
            -webkit-app-region: drag;
            flex-shrink: 0;
            z-index: 20;
            background: transparent;
        }

        /* Left Section: Logo & Model */
        .header-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
            -webkit-app-region: no-drag;
            padding: 10px 14px;
            background: rgba(20, 18, 35, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .logo {
            font-weight: 700;
            font-size: 16px;
            color: #d4bfff;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.3px;
        }

        .logo-icon {
            width: 26px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
        }

        /* Model Dropdown Trigger */
        .model-selector {
            position: relative;
        }

        .model-btn {
            background: rgba(30, 27, 50, 0.8);
            color: #b8a5d4;
            border: 1px solid rgba(139, 92, 246, 0.25);
            padding: 5px 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            width: 145px;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .model-btn:hover {
            background: rgba(45, 40, 70, 0.9);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .model-btn .chevron {
            font-size: 10px;
            opacity: 0.6;
        }

        /* Model Dropdown Menu */
        .model-dropdown {
            position: fixed;
            top: 90px;
            left: 20px;
            background: rgba(18, 16, 30, 0.97);
            border: 1px solid rgba(139, 92, 246, 0.35);
            border-radius: 12px;
            width: 280px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.7),
                0 0 20px rgba(139, 92, 246, 0.15);
            backdrop-filter: blur(16px);
            pointer-events: auto;
            user-select: none;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-option {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.08);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 3px;
            transition: background 0.15s;
        }

        .model-option:hover {
            background: rgba(139, 92, 246, 0.12);
        }

        .model-option.selected-key {
            background: rgba(139, 92, 246, 0.2);
            border-left: 3px solid #8B5CF6;
        }

        .model-option.active {
            border-left: 3px solid #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .opt-name {
            font-weight: 600;
            font-size: 12px;
            color: #e0d4f5;
        }

        .opt-meta {
            font-size: 10px;
            color: #8878a9;
            display: flex;
            gap: 8px;
        }

        .opt-badge {
            background: rgba(139, 92, 246, 0.15);
            padding: 1px 6px;
            border-radius: 4px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        /* Middle Section: Shortcuts */
        .shortcuts-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(20, 18, 35, 0.3);
            padding: 8px 14px;
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            -webkit-app-region: no-drag;
        }

        .shortcut-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #b8a5d4;
            cursor: default;
            min-width: 34px;
            gap: 4px;
        }

        .shortcut-keys {
            background: rgba(25, 22, 45, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.35);
            border-radius: 6px;
            padding: 4px 8px;
            color: #d4bfff;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
            font-weight: 600;
            box-shadow:
                0 2px 4px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .shortcut-keys:hover {
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow:
                0 2px 8px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .shortcut-label {
            font-size: 9px;
            opacity: 0.65;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Divider between shortcuts */
        .shortcut-divider {
            width: 1px;
            height: 32px;
            background: rgba(139, 92, 246, 0.2);
        }

        /* Right Section: Thumbnails */
        .thumbnails-strip {
            flex: 1;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 6px 8px;
            height: 72px;
            align-items: center;
            background: rgba(20, 18, 35, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            -webkit-app-region: no-drag;
        }

        .thumb-item {
            width: 90px;
            height: 60px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s;
        }

        .thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-item:hover {
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
        }

        /* Placeholder text */
        .thumb-placeholder {
            color: #6b5f8a;
            font-size: 11px;
            padding: 0 10px;
            font-style: italic;
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #8B5CF6;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Solution Area */
        .solution-area {
            flex: 1;
            display: none;
            overflow-y: auto;
            padding: 24px;
            border-top: 1px solid rgba(139, 92, 246, 0.15);
            background: rgba(8, 8, 16, 0.2);
            -webkit-app-region: no-drag;
            min-height: 200px;
            pointer-events: none;
        }

        /* Typography */
        .solution-area h1 {
            font-size: 14px;
            color: #e0d4f5;
            margin-top: 0;
            font-weight: 600;
        }

        .solution-area h2 {
            font-size: 12px;
            color: #d4bfff;
            margin-top: 15px;
        }

        .solution-area p {
            color: #c4b5d8;
            font-size: 11px;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .solution-area ul {
            margin-left: 20px;
            color: #c4b5d8;
        }

        .solution-area pre {
            background: rgba(18, 16, 30, 0.3);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            border: 1px solid rgba(139, 92, 246, 0.15);
            margin: 15px 0;
            pointer-events: none;
        }

        .solution-area code {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 11px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
    </style>
</head>

<body>

    <!-- Dropdown Container -->
    <div class="model-dropdown" id="model-list"></div>

    <div id="app">
        <!-- Strip Header -->
        <div class="strip-header">

            <!-- Left: Logo & Model -->
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="26" height="26">
                            <defs>
                                <linearGradient id="symbolGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#00F0FF" />
                                    <stop offset="50%" style="stop-color:#6366F1" />
                                    <stop offset="100%" style="stop-color:#8B5CF6" />
                                </linearGradient>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
                                    <feColorMatrix in="blur" type="matrix"
                                        values="0 0 0 0 0  0 0.9 1 0 0  0 0.5 1 0 0  0 0 0 0.6 0" result="glow" />
                                    <feMerge>
                                        <feMergeNode in="glow" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                            </defs>
                            <circle cx="256" cy="256" r="120" fill="none" stroke="url(#symbolGrad)" stroke-width="28"
                                stroke-linecap="round" filter="url(#glow)" />
                            <line x1="168" y1="348" x2="344" y2="164" stroke="url(#symbolGrad)" stroke-width="28"
                                stroke-linecap="round" filter="url(#glow)" />
                        </svg>
                    </span>
                    NullByte
                    <div id="loading-spinner" class="loader"></div>
                </div>

                <div class="model-selector">
                    <div class="model-btn" id="model-trigger">
                        <span id="current-model-name">Loading...</span>
                        <span class="chevron">▾</span>
                    </div>
                </div>
            </div>

            <!-- Middle: Shortcuts -->
            <div class="shortcuts-bar">
                <div class="shortcut-badge" title="Capture Screenshot">
                    <span class="shortcut-keys">Ctrl+Shift+S</span>
                    <span class="shortcut-label">Capture</span>
                </div>
                <div class="shortcut-divider"></div>
                <div class="shortcut-badge" title="Solve">
                    <span class="shortcut-keys">D</span>
                    <span class="shortcut-label">Solve</span>
                </div>
                <div class="shortcut-divider"></div>
                <div class="shortcut-badge" title="Scroll">
                    <span class="shortcut-keys">↕</span>
                    <span class="shortcut-label">Scroll</span>
                </div>
                <div class="shortcut-divider"></div>
                <div class="shortcut-badge" title="Toggle Overlay">
                    <span class="shortcut-keys">Q</span>
                    <span class="shortcut-label">Hide</span>
                </div>
            </div>

            <!-- Thumbnails (Right Side) -->
            <div class="thumbnails-strip" id="thumbnails">
                <div class="thumb-placeholder">Waiting for Capture...</div>
            </div>
        </div>

        <!-- Solution Content -->
        <div class="solution-area" id="solution-content">
            <p style="text-align: center; color: #8878a9; margin-top: 10px;">
                Solution output area.
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>

    <script>
        const app = document.getElementById('app');
        const thumbnails = document.getElementById('thumbnails');
        const solutionContent = document.querySelector('.solution-area');
        const spinner = document.getElementById('loading-spinner');
        const modelTrigger = document.getElementById('model-trigger');
        const modelList = document.getElementById('model-list');
        const currentModelLabel = document.getElementById('current-model-name');

        // Fixed model list (order matters)
        const ALLOWED_MODELS = [
            { id: 'gemma-3-27b-it', displayName: 'Gemma 3 27B' },
            { id: 'gemini-2.5-flash', displayName: 'Gemini 2.5 Flash' },
            { id: 'gemini-2.0-flash', displayName: 'Gemini 2.0 Flash' }
        ];

        const MODEL_LIMITS = {
            'gemma-3-27b-it': { rpm: '30 RPM', tpm: '15K TPM' },
            'gemini-2.5-flash': { rpm: '5 RPM', tpm: '250K TPM' },
            'gemini-2.0-flash': { rpm: '15 RPM', tpm: '1M TPM' }
        };

        // Auto-Resize Logic
        let isExpanded = false;
        let isDropdownOpen = false;

        const HEIGHT_STRIP = 100; // Small height
        const WIDTH = 850;
        const DROPDOWN_HEIGHT_BUFFER = 400; // Height needed to show dropdown
        const MAX_HEIGHT = 800;

        function adjustHeight() {
            let targetHeight = HEIGHT_STRIP;
            const screenHeight = window.screen.availHeight;
            const safeMaxHeight = Math.min(MAX_HEIGHT, screenHeight * 0.85);

            if (isExpanded) {
                app.style.height = 'auto';
                const appHeight = app.scrollHeight;
                targetHeight = Math.min(Math.max(appHeight, HEIGHT_STRIP), safeMaxHeight);
            } else if (isDropdownOpen) {
                targetHeight = Math.max(HEIGHT_STRIP, DROPDOWN_HEIGHT_BUFFER);
            }

            app.style.height = targetHeight + 'px';

            requestAnimationFrame(() => {
                const h = Math.floor(targetHeight);
                if (Number.isFinite(h) && h > 0) {
                    window.api.resizeWindow({ width: WIDTH, height: h });
                }
            });
        }

        function toggleExpand(forceState = null) {
            if (forceState !== null) isExpanded = forceState;
            else isExpanded = !isExpanded;

            if (isExpanded) {
                isDropdownOpen = false;
                modelList.classList.remove('show');
                window.api.setIgnoreMouse(true);
                solutionContent.style.display = 'block';
            } else {
                solutionContent.style.display = 'none';
            }

            adjustHeight();
        }

        // --- Model Logic ---
        async function loadModels() {
            try {
                const current = await window.api.getCurrentModel();
                if (current) currentModelLabel.textContent = current.split('/')[1] || current;

                // Always use fixed model list
                modelList.innerHTML = '';
                ALLOWED_MODELS.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'model-option ' + (m.id === current ? 'active' : '');
                    const limits = MODEL_LIMITS[m.id] || { rpm: '-', tpm: '-' };
                    div.innerHTML = `
                    <div class="opt-name">${m.displayName}</div>
                    <div class="opt-meta">
                        <span class="opt-badge">${limits.rpm}</span>
                        <span class="opt-badge">${limits.tpm}</span>
                    </div>
                `;
                    div.onclick = async () => {
                        await window.api.setModel(m.id);
                        currentModelLabel.textContent = m.displayName;
                        isDropdownOpen = false;
                        modelList.classList.remove('show');
                        window.api.setIgnoreMouse(true);
                        adjustHeight();
                        updateSelection();
                    };
                    modelList.appendChild(div);
                });
            } catch (e) {
                console.error("Model load error", e);
                currentModelLabel.textContent = "Error";
            }
        }

        // Toggle Dropdown (Click Handler)
        modelTrigger.onclick = (e) => {
        };

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (isDropdownOpen && !e.target.closest('.model-dropdown') && !e.target.closest('.model-btn')) {
                isDropdownOpen = false;
                modelList.classList.remove('show');
                window.api.setIgnoreMouse(true);
                adjustHeight();
            }
        });

        loadModels();

        // DELAYED GHOST MODE
        setTimeout(() => {
            window.api.setIgnoreMouse(true);
        }, 500);

        // Thumbnails
        window.api.onUpdateScreenshots((paths) => {
            thumbnails.innerHTML = '';

            if (paths.length === 0) {
                thumbnails.innerHTML = '<div class="thumb-placeholder">Waiting for Capture...</div>';
                return;
            }
            paths.forEach(path => {
                const div = document.createElement('div');
                div.className = 'thumb-item';
                const cleanPath = path.replace(/\\/g, '/');
                div.innerHTML = `<img src="file://${cleanPath}" />`;
                thumbnails.appendChild(div);
            });
            thumbnails.scrollLeft = thumbnails.scrollWidth;
        });

        // States
        window.api.onForceCollapse(() => toggleExpand(false));
        window.api.onForceExpand(() => toggleExpand(true));

        window.api.onGeminiStatus((status) => {
            if (status === 'thinking') {
                spinner.style.display = 'inline-block';
                toggleExpand(true);
                solutionContent.innerHTML = '<p style="color: #8B5CF6;">Analyzing...</p>';
            } else {
                spinner.style.display = 'none';
            }
        });

        window.api.onGeminiResponse((text) => {
            solutionContent.innerHTML = marked.parse(text);
            Prism.highlightAll();
            adjustHeight();
        });

        // Scrolling Fix
        window.api.onScrollEvent((direction) => {
            if (isExpanded && solutionContent.style.display !== 'none') {
                const scrollAmount = 150;
                if (direction === 'up') {
                    solutionContent.scrollTop -= scrollAmount;
                } else if (direction === 'down') {
                    solutionContent.scrollTop += scrollAmount;
                } else if (direction === 'left') {
                    const codeBlocks = solutionContent.querySelectorAll('pre');
                    codeBlocks.forEach(block => block.scrollLeft -= scrollAmount);
                    solutionContent.scrollLeft -= scrollAmount;
                } else if (direction === 'right') {
                    const codeBlocks = solutionContent.querySelectorAll('pre');
                    codeBlocks.forEach(block => block.scrollLeft += scrollAmount);
                    solutionContent.scrollLeft += scrollAmount;
                }
            }
        });

        // --- Dropdown Keyboard Navigation & Logic ---
        let selectedIndex = 0;

        function updateSelection() {
            const options = document.querySelectorAll('.model-option');
            if (options.length === 0) return;

            // Clamp
            if (selectedIndex < 0) selectedIndex = options.length - 1;
            if (selectedIndex >= options.length) selectedIndex = 0;

            options.forEach((opt, idx) => {
                if (idx === selectedIndex) {
                    opt.classList.add('selected-key');
                    opt.scrollIntoView({ block: 'nearest' });
                } else {
                    opt.classList.remove('selected-key');
                }
            });
        }

        // Toggle Listener (Triggered by Ctrl+Shift+M)
        window.api.onToggleModelDropdown(() => {
            console.log("Toggle Dropdown Received");
            isDropdownOpen = !isDropdownOpen;

            if (isDropdownOpen) {
                modelList.classList.add('show');
                window.api.setIgnoreMouse(false);

                requestAnimationFrame(() => {
                    selectedIndex = 0;
                    updateSelection();
                });
            } else {
                modelList.classList.remove('show');
                window.api.setIgnoreMouse(true);
            }
            adjustHeight();
        });

        // Global Keydown (Only when interactive/focused)
        window.addEventListener('keydown', (e) => {
            if (!isDropdownOpen) return;

            const options = document.querySelectorAll('.model-option');
            if (options.length === 0) return;

            if (e.key === 'ArrowDown') {
                selectedIndex++;
                updateSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowUp') {
                selectedIndex--;
                updateSelection();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                if (selectedIndex >= 0 && selectedIndex < options.length) {
                    options[selectedIndex].click();
                }
                e.preventDefault();
            } else if (e.key === 'Escape') {
                isDropdownOpen = false;
                modelList.classList.remove('show');
                window.api.setIgnoreMouse(true);
                adjustHeight();
            }
        });

    </script>
</body>

</html>